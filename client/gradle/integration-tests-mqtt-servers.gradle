class MosquittoServer extends DefaultTask {
    Process process
    Thread childThread
    File configurationDirectory
    String configurationFileName
    
    MosquittoServer() {
        configurationDirectory = new File(project.projectDir, "/gradle/configurations")
    }


    @TaskAction void startServer() {
        ProcessBuilder pb = new ProcessBuilder()
                .directory(configurationDirectory)
                .command "mosquitto", "-c", configurationFileName
        pb.redirectErrorStream(true)
        process = pb.start()
        BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()))

        childThread = new Thread(new Runnable() {
            @Override
            void run() {
                for (String line = reader.readLine(); line != null; line = reader.readLine()) {
                    println("[$configurationFileName] $line")
                }
                reader.close()
            }
        })
        childThread.start()
    }

    void shutdown() {
        try {
            if (process != null) {
                process.destroy()
                process = null
            }
        } catch (Exception e) {
        } finally {
            if (process != null) {
                process.destroyForcibly()
            }
        }
    }
}

task stopMosquittoTLS60001() {
    doLast {
        tasks.startMosquittoTLS60001.shutdown()
    }
}

task startMosquittoTLS60001(type: MosquittoServer) {
    configurationFileName = "mosquitto_tls_1.3_60001.conf"
    doFirst{
        println(configurationDirectory.absolutePath)
        println(configurationFileName)

    }
}

task stopMosquitto1883Default() {
    doLast {
        tasks.startMosquitto1883Default.shutdown()
    }
}

task startMosquitto1883Default(type: MosquittoServer) {
    configurationFileName = "mosquitto_default_1883.conf"
}
